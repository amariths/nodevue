import { isPlatformBrowser } from '@angular/common';
import { Inject, Injectable, InjectionToken, Optional, PLATFORM_ID } from '@angular/core';
import { marked, Renderer } from 'marked';
import { Subject } from 'rxjs';
import { map } from 'rxjs/operators';
import { ClipboardButtonComponent } from './clipboard-button.component';
import { MarkedRenderer } from './marked-renderer';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./clipboard-options";
import * as i3 from "./marked-options";
import * as i4 from "@angular/platform-browser";
/* eslint-disable max-len */
export const errorJoyPixelsNotLoaded = '[ngx-markdown] When using the `emoji` attribute you *have to* include Emoji-Toolkit files to `angular.json` or use imports. See README for more information';
export const errorKatexNotLoaded = '[ngx-markdown] When using the `katex` attribute you *have to* include KaTeX files to `angular.json` or use imports. See README for more information';
export const errorMermaidNotLoaded = '[ngx-markdown] When using the `mermaid` attribute you *have to* include Mermaid files to `angular.json` or use imports. See README for more information';
export const errorClipboardNotLoaded = '[ngx-markdown] When using the `clipboard` attribute you *have to* include Clipboard files to `angular.json` or use imports. See README for more information';
export const errorClipboardViewContainerRequired = '[ngx-markdown] When using the `clipboard` attribute you *have to* provide the `viewContainerRef` parameter to `MarkdownService.render()` function';
export const errorSrcWithoutHttpClient = '[ngx-markdown] When using the `src` attribute you *have to* pass the `HttpClient` as a parameter of the `forRoot` method. See README for more information';
/* eslint-enable max-len */
export const SECURITY_CONTEXT = new InjectionToken('SECURITY_CONTEXT');
export class ExtendedRenderer extends Renderer {
    constructor() {
        super(...arguments);
        this.ɵNgxMarkdownRendererExtended = false;
    }
}
export class MarkdownService {
    constructor(platform, securityContext, http, clipboardOptions, options, sanitizer) {
        this.platform = platform;
        this.securityContext = securityContext;
        this.http = http;
        this.clipboardOptions = clipboardOptions;
        this.sanitizer = sanitizer;
        this.DEFAULT_MARKED_OPTIONS = {
            renderer: new MarkedRenderer(),
        };
        this.DEFAULT_KATEX_OPTIONS = {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\begin{equation}", right: "\\end{equation}", display: true },
                { left: "\\begin{align}", right: "\\end{align}", display: true },
                { left: "\\begin{alignat}", right: "\\end{alignat}", display: true },
                { left: "\\begin{gather}", right: "\\end{gather}", display: true },
                { left: "\\begin{CD}", right: "\\end{CD}", display: true },
                { left: "\\[", right: "\\]", display: true },
            ],
        };
        this.DEFAULT_MERMAID_OPTIONS = {
            startOnLoad: false,
        };
        this.DEFAULT_CLIPBOARD_OPTIONS = {
            buttonComponent: undefined,
        };
        this.DEFAULT_PARSE_OPTIONS = {
            decodeHtml: false,
            inline: false,
            emoji: false,
            mermaid: false,
            markedOptions: this.DEFAULT_MARKED_OPTIONS,
            disableSanitizer: false,
        };
        this.DEFAULT_RENDER_OPTIONS = {
            clipboard: false,
            clipboardOptions: undefined,
            katex: false,
            katexOptions: undefined,
            mermaid: false,
            mermaidOptions: undefined,
        };
        this._reload$ = new Subject();
        this.reload$ = this._reload$.asObservable();
        this.options = options;
    }
    get options() { return this._options; }
    set options(value) {
        this._options = { ...this.DEFAULT_MARKED_OPTIONS, ...value };
    }
    get renderer() { return this.options.renderer; }
    set renderer(value) {
        this.options.renderer = value;
    }
    parse(markdown, parseOptions = this.DEFAULT_PARSE_OPTIONS) {
        const { decodeHtml, inline, emoji, mermaid, disableSanitizer, } = parseOptions;
        const markedOptions = {
            ...this.options,
            ...parseOptions.markedOptions,
        };
        if (mermaid) {
            this.renderer = this.extendRenderer(markedOptions.renderer || new Renderer());
        }
        const trimmed = this.trimIndentation(markdown);
        const decoded = decodeHtml ? this.decodeHtml(trimmed) : trimmed;
        const emojified = emoji ? this.parseEmoji(decoded) : decoded;
        const marked = this.parseMarked(emojified, markedOptions, inline);
        const sanitized = disableSanitizer ? marked : this.sanitizer.sanitize(this.securityContext, marked);
        return sanitized || '';
    }
    render(element, options = this.DEFAULT_RENDER_OPTIONS, viewContainerRef) {
        const { clipboard, clipboardOptions, katex, katexOptions, mermaid, mermaidOptions, } = options;
        if (clipboard) {
            this.renderClipboard(element, viewContainerRef, {
                ...this.DEFAULT_CLIPBOARD_OPTIONS,
                ...this.clipboardOptions,
                ...clipboardOptions,
            });
        }
        if (katex) {
            this.renderKatex(element, {
                ...this.DEFAULT_KATEX_OPTIONS,
                ...katexOptions,
            });
        }
        if (mermaid) {
            this.renderMermaid(element, {
                ...this.DEFAULT_MERMAID_OPTIONS,
                ...mermaidOptions,
            });
        }
        this.highlight(element);
    }
    reload() {
        this._reload$.next();
    }
    getSource(src) {
        if (!this.http) {
            throw new Error(errorSrcWithoutHttpClient);
        }
        return this.http
            .get(src, { responseType: 'text' })
            .pipe(map(markdown => this.handleExtension(src, markdown)));
    }
    highlight(element) {
        if (!isPlatformBrowser(this.platform)) {
            return;
        }
        if (typeof Prism === 'undefined' || typeof Prism.highlightAllUnder === 'undefined') {
            return;
        }
        if (!element) {
            element = document;
        }
        const noLanguageElements = element.querySelectorAll('pre code:not([class*="language-"])');
        Array.prototype.forEach.call(noLanguageElements, (x) => x.classList.add('language-none'));
        Prism.highlightAllUnder(element);
    }
    decodeHtml(html) {
        if (!isPlatformBrowser(this.platform)) {
            return html;
        }
        const textarea = document.createElement('textarea');
        textarea.innerHTML = html;
        return textarea.value;
    }
    extendRenderer(renderer) {
        const extendedRenderer = renderer;
        if (extendedRenderer.ɵNgxMarkdownRendererExtended === true) {
            return renderer;
        }
        // eslint-disable-next-line @typescript-eslint/unbound-method
        const defaultCode = renderer.code;
        renderer.code = function (code, language, isEscaped) {
            return language === 'mermaid'
                ? `<div class="mermaid">${code}</div>`
                : defaultCode.call(this, code, language, isEscaped);
        };
        extendedRenderer.ɵNgxMarkdownRendererExtended = true;
        return renderer;
    }
    handleExtension(src, markdown) {
        const urlProtocolIndex = src.lastIndexOf('://');
        const urlWithoutProtocol = urlProtocolIndex > -1
            ? src.substring(urlProtocolIndex + 4)
            : src;
        const lastSlashIndex = urlWithoutProtocol.lastIndexOf('/');
        const lastUrlSegment = lastSlashIndex > -1
            ? urlWithoutProtocol.substring(lastSlashIndex + 1).split('?')[0]
            : '';
        const lastDotIndex = lastUrlSegment.lastIndexOf('.');
        const extension = lastDotIndex > -1
            ? lastUrlSegment.substring(lastDotIndex + 1)
            : '';
        return !!extension && extension !== 'md'
            ? '```' + extension + '\n' + markdown + '\n```'
            : markdown;
    }
    parseMarked(html, markedOptions, inline = false) {
        if (!isPlatformBrowser(this.platform)) {
            return html;
        }
        if (inline) {
            return marked.parseInline(html, markedOptions);
        }
        return marked.parse(html, markedOptions);
    }
    parseEmoji(html) {
        if (!isPlatformBrowser(this.platform)) {
            return html;
        }
        if (typeof joypixels === 'undefined' || typeof joypixels.shortnameToUnicode === 'undefined') {
            throw new Error(errorJoyPixelsNotLoaded);
        }
        return joypixels.shortnameToUnicode(html);
    }
    renderKatex(element, options) {
        if (!isPlatformBrowser(this.platform)) {
            return;
        }
        if (typeof katex === 'undefined' || typeof renderMathInElement === 'undefined') {
            throw new Error(errorKatexNotLoaded);
        }
        renderMathInElement(element, options);
    }
    renderClipboard(element, viewContainerRef, options) {
        if (!isPlatformBrowser(this.platform)) {
            return;
        }
        if (typeof ClipboardJS === 'undefined') {
            throw new Error(errorClipboardNotLoaded);
        }
        if (!viewContainerRef) {
            throw new Error(errorClipboardViewContainerRequired);
        }
        const { buttonComponent, buttonTemplate, } = options;
        // target every <pre> elements
        const preElements = element.querySelectorAll('pre');
        for (let i = 0; i < preElements.length; i++) {
            const preElement = preElements.item(i);
            // create <pre> wrapper element
            const preWrapperElement = document.createElement('div');
            preWrapperElement.style.position = 'relative';
            preElement.parentNode.insertBefore(preWrapperElement, preElement);
            preWrapperElement.appendChild(preElement);
            // create toolbar element
            const toolbarWrapperElement = document.createElement('div');
            toolbarWrapperElement.style.position = 'absolute';
            toolbarWrapperElement.style.top = '.5em';
            toolbarWrapperElement.style.right = '.5em';
            toolbarWrapperElement.style.opacity = '0';
            toolbarWrapperElement.style.transition = 'opacity 250ms ease-out';
            preWrapperElement.insertAdjacentElement('beforeend', toolbarWrapperElement);
            // register listener to show/hide toolbar
            preElement.onmouseover = () => toolbarWrapperElement.style.opacity = '1';
            preElement.onmouseout = () => toolbarWrapperElement.style.opacity = '0';
            // declare embeddedViewRef holding variable
            let embeddedViewRef;
            // use provided component via input property
            // or provided via ClipboardOptions provider
            if (buttonComponent) {
                const componentRef = viewContainerRef.createComponent(buttonComponent);
                embeddedViewRef = componentRef.hostView;
            }
            // use provided template via input property
            else if (buttonTemplate) {
                embeddedViewRef = viewContainerRef.createEmbeddedView(buttonTemplate);
            }
            // use default component
            else {
                const componentRef = viewContainerRef.createComponent(ClipboardButtonComponent);
                embeddedViewRef = componentRef.hostView;
            }
            // declare clipboard instance variable
            let clipboardInstance;
            // attach clipboard.js to root node
            embeddedViewRef.rootNodes.forEach((node) => {
                node.onmouseover = () => toolbarWrapperElement.style.opacity = '1';
                toolbarWrapperElement.appendChild(node);
                clipboardInstance = new ClipboardJS(node, { text: () => preElement.innerText });
            });
            // destroy clipboard instance when view is destroyed
            embeddedViewRef.onDestroy(() => clipboardInstance.destroy());
        }
    }
    renderMermaid(element, options = this.DEFAULT_MERMAID_OPTIONS) {
        if (!isPlatformBrowser(this.platform)) {
            return;
        }
        if (typeof mermaid === 'undefined' || typeof mermaid.init === 'undefined') {
            throw new Error(errorMermaidNotLoaded);
        }
        const mermaidElements = element.querySelectorAll('.mermaid');
        if (mermaidElements.length === 0) {
            return;
        }
        mermaid.initialize(options);
        mermaid.init(mermaidElements);
    }
    trimIndentation(markdown) {
        if (!markdown) {
            return '';
        }
        let indentStart;
        return markdown
            .split('\n')
            .map(line => {
            let lineIdentStart = indentStart;
            if (line.length > 0) {
                lineIdentStart = isNaN(lineIdentStart)
                    ? line.search(/\S|$/)
                    : Math.min(line.search(/\S|$/), lineIdentStart);
            }
            if (isNaN(indentStart)) {
                indentStart = lineIdentStart;
            }
            return lineIdentStart
                ? line.substring(lineIdentStart)
                : line;
        }).join('\n');
    }
}
MarkdownService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.0.0", ngImport: i0, type: MarkdownService, deps: [{ token: PLATFORM_ID }, { token: SECURITY_CONTEXT }, { token: i1.HttpClient, optional: true }, { token: i2.ClipboardOptions, optional: true }, { token: i3.MarkedOptions, optional: true }, { token: i4.DomSanitizer }], target: i0.ɵɵFactoryTarget.Injectable });
MarkdownService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.0.0", ngImport: i0, type: MarkdownService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.0.0", ngImport: i0, type: MarkdownService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: Object, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: i0.SecurityContext, decorators: [{
                    type: Inject,
                    args: [SECURITY_CONTEXT]
                }] }, { type: i1.HttpClient, decorators: [{
                    type: Optional
                }] }, { type: i2.ClipboardOptions, decorators: [{
                    type: Optional
                }] }, { type: i3.MarkedOptions, decorators: [{
                    type: Optional
                }] }, { type: i4.DomSanitizer }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFya2Rvd24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2xpYi9zcmMvbWFya2Rvd24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUVwRCxPQUFPLEVBQW1CLE1BQU0sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQXFDLE1BQU0sZUFBZSxDQUFDO0FBRTlJLE9BQU8sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQzFDLE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJDLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBSXhFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQzs7Ozs7O0FBaUNuRCw0QkFBNEI7QUFDNUIsTUFBTSxDQUFDLE1BQU0sdUJBQXVCLEdBQUcsNkpBQTZKLENBQUM7QUFDck0sTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQUcscUpBQXFKLENBQUM7QUFDekwsTUFBTSxDQUFDLE1BQU0scUJBQXFCLEdBQUcseUpBQXlKLENBQUM7QUFDL0wsTUFBTSxDQUFDLE1BQU0sdUJBQXVCLEdBQUcsNkpBQTZKLENBQUM7QUFDck0sTUFBTSxDQUFDLE1BQU0sbUNBQW1DLEdBQUcsbUpBQW1KLENBQUM7QUFDdk0sTUFBTSxDQUFDLE1BQU0seUJBQXlCLEdBQUcsMkpBQTJKLENBQUM7QUFDck0sMkJBQTJCO0FBRTNCLE1BQU0sQ0FBQyxNQUFNLGdCQUFnQixHQUFHLElBQUksY0FBYyxDQUFrQixrQkFBa0IsQ0FBQyxDQUFDO0FBb0J4RixNQUFNLE9BQU8sZ0JBQWlCLFNBQVEsUUFBUTtJQUE5Qzs7UUFDRSxpQ0FBNEIsR0FBRyxLQUFLLENBQUM7SUFDdkMsQ0FBQztDQUFBO0FBR0QsTUFBTSxPQUFPLGVBQWU7SUE2RDFCLFlBQytCLFFBQWdCLEVBQ1gsZUFBZ0MsRUFDOUMsSUFBZ0IsRUFDaEIsZ0JBQWtDLEVBQzFDLE9BQXNCLEVBQzFCLFNBQXVCO1FBTEYsYUFBUSxHQUFSLFFBQVEsQ0FBUTtRQUNYLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUM5QyxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFFOUMsY0FBUyxHQUFULFNBQVMsQ0FBYztRQWpFaEIsMkJBQXNCLEdBQWtCO1lBQ3ZELFFBQVEsRUFBRSxJQUFJLGNBQWMsRUFBRTtTQUMvQixDQUFDO1FBRWUsMEJBQXFCLEdBQWlCO1lBQ3JELFVBQVUsRUFBRTtnQkFDVixFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFO2dCQUMxQyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFO2dCQUN6QyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFO2dCQUM3QyxFQUFFLElBQUksRUFBRSxtQkFBbUIsRUFBRSxLQUFLLEVBQUUsaUJBQWlCLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRTtnQkFDdEUsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLGNBQWMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFO2dCQUNoRSxFQUFFLElBQUksRUFBRSxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsZ0JBQWdCLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRTtnQkFDcEUsRUFBRSxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsS0FBSyxFQUFFLGVBQWUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFO2dCQUNsRSxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFO2dCQUMxRCxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFO2FBQzdDO1NBQ0YsQ0FBQztRQUVlLDRCQUF1QixHQUFzQjtZQUM1RCxXQUFXLEVBQUUsS0FBSztTQUNuQixDQUFDO1FBRWUsOEJBQXlCLEdBQXFCO1lBQzdELGVBQWUsRUFBRSxTQUFTO1NBQzNCLENBQUM7UUFFZSwwQkFBcUIsR0FBaUI7WUFDckQsVUFBVSxFQUFFLEtBQUs7WUFDakIsTUFBTSxFQUFFLEtBQUs7WUFDYixLQUFLLEVBQUUsS0FBSztZQUNaLE9BQU8sRUFBRSxLQUFLO1lBQ2QsYUFBYSxFQUFFLElBQUksQ0FBQyxzQkFBc0I7WUFDMUMsZ0JBQWdCLEVBQUUsS0FBSztTQUN4QixDQUFDO1FBRWUsMkJBQXNCLEdBQWtCO1lBQ3ZELFNBQVMsRUFBRSxLQUFLO1lBQ2hCLGdCQUFnQixFQUFFLFNBQVM7WUFDM0IsS0FBSyxFQUFFLEtBQUs7WUFDWixZQUFZLEVBQUUsU0FBUztZQUN2QixPQUFPLEVBQUUsS0FBSztZQUNkLGNBQWMsRUFBRSxTQUFTO1NBQzFCLENBQUM7UUFjZSxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUN2QyxZQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQVU5QyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUN6QixDQUFDO0lBdEJELElBQUksT0FBTyxLQUFvQixPQUFPLElBQUksQ0FBQyxRQUFTLENBQUMsQ0FBQyxDQUFDO0lBQ3ZELElBQUksT0FBTyxDQUFDLEtBQWdDO1FBQzFDLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxHQUFHLEtBQUssRUFBRSxDQUFDO0lBQy9ELENBQUM7SUFFRCxJQUFJLFFBQVEsS0FBcUIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVMsQ0FBQyxDQUFDLENBQUM7SUFDakUsSUFBSSxRQUFRLENBQUMsS0FBcUI7UUFDaEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO0lBQ2hDLENBQUM7SUFnQkQsS0FBSyxDQUFDLFFBQWdCLEVBQUUsZUFBNkIsSUFBSSxDQUFDLHFCQUFxQjtRQUM3RSxNQUFNLEVBQ0osVUFBVSxFQUNWLE1BQU0sRUFDTixLQUFLLEVBQ0wsT0FBTyxFQUNQLGdCQUFnQixHQUNqQixHQUFHLFlBQVksQ0FBQztRQUVqQixNQUFNLGFBQWEsR0FBRztZQUNwQixHQUFHLElBQUksQ0FBQyxPQUFPO1lBQ2YsR0FBRyxZQUFZLENBQUMsYUFBYTtTQUM5QixDQUFDO1FBRUYsSUFBSSxPQUFPLEVBQUU7WUFDWCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLFFBQVEsSUFBSSxJQUFJLFFBQVEsRUFBRSxDQUFDLENBQUM7U0FDL0U7UUFFRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQy9DLE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1FBQ2hFLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1FBQzdELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLGFBQWEsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNsRSxNQUFNLFNBQVMsR0FBRyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRXBHLE9BQU8sU0FBUyxJQUFJLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBRUQsTUFBTSxDQUFDLE9BQW9CLEVBQUUsVUFBeUIsSUFBSSxDQUFDLHNCQUFzQixFQUFFLGdCQUFtQztRQUNwSCxNQUFNLEVBQ0osU0FBUyxFQUNULGdCQUFnQixFQUNoQixLQUFLLEVBQ0wsWUFBWSxFQUNaLE9BQU8sRUFDUCxjQUFjLEdBQ2YsR0FBRyxPQUFPLENBQUM7UUFFWixJQUFJLFNBQVMsRUFBRTtZQUNiLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLGdCQUFnQixFQUFFO2dCQUM5QyxHQUFHLElBQUksQ0FBQyx5QkFBeUI7Z0JBQ2pDLEdBQUcsSUFBSSxDQUFDLGdCQUFnQjtnQkFDeEIsR0FBRyxnQkFBZ0I7YUFDcEIsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxJQUFJLEtBQUssRUFBRTtZQUNULElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFO2dCQUN4QixHQUFHLElBQUksQ0FBQyxxQkFBcUI7Z0JBQzdCLEdBQUcsWUFBWTthQUNoQixDQUFDLENBQUM7U0FDSjtRQUNELElBQUksT0FBTyxFQUFFO1lBQ1gsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUU7Z0JBQzFCLEdBQUcsSUFBSSxDQUFDLHVCQUF1QjtnQkFDL0IsR0FBRyxjQUFjO2FBQ2xCLENBQUMsQ0FBQztTQUNKO1FBRUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRUQsTUFBTTtRQUNKLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVELFNBQVMsQ0FBQyxHQUFXO1FBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ2QsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1NBQzVDO1FBQ0QsT0FBTyxJQUFJLENBQUMsSUFBSTthQUNiLEdBQUcsQ0FBQyxHQUFHLEVBQUUsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLENBQUM7YUFDbEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoRSxDQUFDO0lBRUQsU0FBUyxDQUFDLE9BQTRCO1FBQ3BDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDckMsT0FBTztTQUNSO1FBQ0QsSUFBSSxPQUFPLEtBQUssS0FBSyxXQUFXLElBQUksT0FBTyxLQUFLLENBQUMsaUJBQWlCLEtBQUssV0FBVyxFQUFFO1lBQ2xGLE9BQU87U0FDUjtRQUNELElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDWixPQUFPLEdBQUcsUUFBUSxDQUFDO1NBQ3BCO1FBQ0QsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsb0NBQW9DLENBQUMsQ0FBQztRQUMxRixLQUFLLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxDQUFVLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7UUFDbkcsS0FBSyxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFTyxVQUFVLENBQUMsSUFBWTtRQUM3QixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ3JDLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3BELFFBQVEsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQzFCLE9BQU8sUUFBUSxDQUFDLEtBQUssQ0FBQztJQUN4QixDQUFDO0lBRU8sY0FBYyxDQUFDLFFBQWtCO1FBQ3ZDLE1BQU0sZ0JBQWdCLEdBQUcsUUFBNEIsQ0FBQztRQUN0RCxJQUFJLGdCQUFnQixDQUFDLDRCQUE0QixLQUFLLElBQUksRUFBRTtZQUMxRCxPQUFPLFFBQVEsQ0FBQztTQUNqQjtRQUVELDZEQUE2RDtRQUM3RCxNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQ2xDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsVUFBVSxJQUFZLEVBQUUsUUFBNEIsRUFBRSxTQUFrQjtZQUN0RixPQUFPLFFBQVEsS0FBSyxTQUFTO2dCQUMzQixDQUFDLENBQUMsd0JBQXdCLElBQUksUUFBUTtnQkFDdEMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDeEQsQ0FBQyxDQUFDO1FBRUYsZ0JBQWdCLENBQUMsNEJBQTRCLEdBQUcsSUFBSSxDQUFDO1FBRXJELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFTyxlQUFlLENBQUMsR0FBVyxFQUFFLFFBQWdCO1FBQ25ELE1BQU0sZ0JBQWdCLEdBQUcsR0FBRyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNoRCxNQUFNLGtCQUFrQixHQUFHLGdCQUFnQixHQUFHLENBQUMsQ0FBQztZQUM5QyxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUM7WUFDckMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztRQUVSLE1BQU0sY0FBYyxHQUFHLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzRCxNQUFNLGNBQWMsR0FBRyxjQUFjLEdBQUcsQ0FBQyxDQUFDO1lBQ3hDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUVQLE1BQU0sWUFBWSxHQUFHLGNBQWMsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDckQsTUFBTSxTQUFTLEdBQUcsWUFBWSxHQUFHLENBQUMsQ0FBQztZQUNqQyxDQUFDLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDO1lBQzVDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFFUCxPQUFPLENBQUMsQ0FBQyxTQUFTLElBQUksU0FBUyxLQUFLLElBQUk7WUFDdEMsQ0FBQyxDQUFDLEtBQUssR0FBRyxTQUFTLEdBQUcsSUFBSSxHQUFHLFFBQVEsR0FBRyxPQUFPO1lBQy9DLENBQUMsQ0FBQyxRQUFRLENBQUM7SUFDZixDQUFDO0lBRU8sV0FBVyxDQUFDLElBQVksRUFBRSxhQUE0QixFQUFFLE1BQU0sR0FBRyxLQUFLO1FBQzVFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDckMsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELElBQUksTUFBTSxFQUFFO1lBQ1YsT0FBTyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQztTQUNoRDtRQUNELE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVPLFVBQVUsQ0FBQyxJQUFZO1FBQzdCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDckMsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELElBQUksT0FBTyxTQUFTLEtBQUssV0FBVyxJQUFJLE9BQU8sU0FBUyxDQUFDLGtCQUFrQixLQUFLLFdBQVcsRUFBRTtZQUMzRixNQUFNLElBQUksS0FBSyxDQUFDLHVCQUF1QixDQUFDLENBQUM7U0FDMUM7UUFDRCxPQUFPLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRU8sV0FBVyxDQUFDLE9BQW9CLEVBQUUsT0FBcUI7UUFDN0QsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUNyQyxPQUFPO1NBQ1I7UUFDRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFdBQVcsSUFBSSxPQUFPLG1CQUFtQixLQUFLLFdBQVcsRUFBRTtZQUM5RSxNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7U0FDdEM7UUFDRCxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVPLGVBQWUsQ0FBQyxPQUFvQixFQUFFLGdCQUE4QyxFQUFFLE9BQStCO1FBQzNILElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDckMsT0FBTztTQUNSO1FBQ0QsSUFBSSxPQUFPLFdBQVcsS0FBSyxXQUFXLEVBQUU7WUFDdEMsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1NBQzFDO1FBQ0QsSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQ3JCLE1BQU0sSUFBSSxLQUFLLENBQUMsbUNBQW1DLENBQUMsQ0FBQztTQUN0RDtRQUVELE1BQU0sRUFDSixlQUFlLEVBQ2YsY0FBYyxHQUNmLEdBQUcsT0FBTyxDQUFDO1FBRVosOEJBQThCO1FBQzlCLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNwRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMzQyxNQUFNLFVBQVUsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXZDLCtCQUErQjtZQUMvQixNQUFNLGlCQUFpQixHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDeEQsaUJBQWlCLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxVQUFVLENBQUM7WUFDOUMsVUFBVSxDQUFDLFVBQVcsQ0FBQyxZQUFZLENBQUMsaUJBQWlCLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDbkUsaUJBQWlCLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRTFDLHlCQUF5QjtZQUN6QixNQUFNLHFCQUFxQixHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDNUQscUJBQXFCLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxVQUFVLENBQUM7WUFDbEQscUJBQXFCLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxNQUFNLENBQUM7WUFDekMscUJBQXFCLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUM7WUFDM0MscUJBQXFCLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUM7WUFDMUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyx3QkFBd0IsQ0FBQztZQUNsRSxpQkFBaUIsQ0FBQyxxQkFBcUIsQ0FBQyxXQUFXLEVBQUUscUJBQXFCLENBQUMsQ0FBQztZQUU1RSx5Q0FBeUM7WUFDekMsVUFBVSxDQUFDLFdBQVcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQztZQUN6RSxVQUFVLENBQUMsVUFBVSxHQUFHLEdBQUcsRUFBRSxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDO1lBRXhFLDJDQUEyQztZQUMzQyxJQUFJLGVBQXlDLENBQUM7WUFFOUMsNENBQTRDO1lBQzVDLDRDQUE0QztZQUM1QyxJQUFJLGVBQWUsRUFBRTtnQkFDbkIsTUFBTSxZQUFZLEdBQUcsZ0JBQWdCLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQyxDQUFDO2dCQUN2RSxlQUFlLEdBQUcsWUFBWSxDQUFDLFFBQW9DLENBQUM7YUFDckU7WUFDRCwyQ0FBMkM7aUJBQ3RDLElBQUksY0FBYyxFQUFFO2dCQUN2QixlQUFlLEdBQUcsZ0JBQWdCLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDLENBQUM7YUFDdkU7WUFDRCx3QkFBd0I7aUJBQ25CO2dCQUNILE1BQU0sWUFBWSxHQUFHLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO2dCQUNoRixlQUFlLEdBQUcsWUFBWSxDQUFDLFFBQW9DLENBQUM7YUFDckU7WUFFRCxzQ0FBc0M7WUFDdEMsSUFBSSxpQkFBcUMsQ0FBQztZQUUxQyxtQ0FBbUM7WUFDbkMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFpQixFQUFFLEVBQUU7Z0JBQ3RELElBQUksQ0FBQyxXQUFXLEdBQUcsR0FBRyxFQUFFLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUM7Z0JBQ25FLHFCQUFxQixDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDeEMsaUJBQWlCLEdBQUcsSUFBSSxXQUFXLENBQUMsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO1lBQ2xGLENBQUMsQ0FBQyxDQUFDO1lBRUgsb0RBQW9EO1lBQ3BELGVBQWUsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsaUJBQWlCLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztTQUM5RDtJQUNILENBQUM7SUFFTyxhQUFhLENBQUMsT0FBb0IsRUFBRSxVQUE2QixJQUFJLENBQUMsdUJBQXVCO1FBQ25HLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDckMsT0FBTztTQUNSO1FBQ0QsSUFBSSxPQUFPLE9BQU8sS0FBSyxXQUFXLElBQUksT0FBTyxPQUFPLENBQUMsSUFBSSxLQUFLLFdBQVcsRUFBRTtZQUN6RSxNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7U0FDeEM7UUFDRCxNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDN0QsSUFBSSxlQUFlLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUNoQyxPQUFPO1NBQ1I7UUFDRCxPQUFPLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzVCLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVPLGVBQWUsQ0FBQyxRQUFnQjtRQUN0QyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2IsT0FBTyxFQUFFLENBQUM7U0FDWDtRQUNELElBQUksV0FBbUIsQ0FBQztRQUN4QixPQUFPLFFBQVE7YUFDWixLQUFLLENBQUMsSUFBSSxDQUFDO2FBQ1gsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ1YsSUFBSSxjQUFjLEdBQUcsV0FBVyxDQUFDO1lBQ2pDLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ25CLGNBQWMsR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFDO29CQUNwQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7b0JBQ3JCLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsY0FBYyxDQUFDLENBQUM7YUFDbkQ7WUFDRCxJQUFJLEtBQUssQ0FBQyxXQUFXLENBQUMsRUFBRTtnQkFDdEIsV0FBVyxHQUFHLGNBQWMsQ0FBQzthQUM5QjtZQUNELE9BQU8sY0FBYztnQkFDbkIsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDO2dCQUNoQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ1gsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xCLENBQUM7OzRHQTdWVSxlQUFlLGtCQThEaEIsV0FBVyxhQUNYLGdCQUFnQjtnSEEvRGYsZUFBZTsyRkFBZixlQUFlO2tCQUQzQixVQUFVOzswQkErRE4sTUFBTTsyQkFBQyxXQUFXOzswQkFDbEIsTUFBTTsyQkFBQyxnQkFBZ0I7OzBCQUN2QixRQUFROzswQkFDUixRQUFROzswQkFDUixRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBFbWJlZGRlZFZpZXdSZWYsIEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIE9wdGlvbmFsLCBQTEFURk9STV9JRCwgU2VjdXJpdHlDb250ZXh0LCBWaWV3Q29udGFpbmVyUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IERvbVNhbml0aXplciB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xyXG5pbXBvcnQgeyBtYXJrZWQsIFJlbmRlcmVyIH0gZnJvbSAnbWFya2VkJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBDbGlwYm9hcmRCdXR0b25Db21wb25lbnQgfSBmcm9tICcuL2NsaXBib2FyZC1idXR0b24uY29tcG9uZW50JztcclxuaW1wb3J0IHsgQ2xpcGJvYXJkT3B0aW9ucywgQ2xpcGJvYXJkUmVuZGVyT3B0aW9ucyB9IGZyb20gJy4vY2xpcGJvYXJkLW9wdGlvbnMnO1xyXG5pbXBvcnQgeyBLYXRleE9wdGlvbnMgfSBmcm9tICcuL2thdGV4LW9wdGlvbnMnO1xyXG5pbXBvcnQgeyBNYXJrZWRPcHRpb25zIH0gZnJvbSAnLi9tYXJrZWQtb3B0aW9ucyc7XHJcbmltcG9ydCB7IE1hcmtlZFJlbmRlcmVyIH0gZnJvbSAnLi9tYXJrZWQtcmVuZGVyZXInO1xyXG5pbXBvcnQgeyBNZXJtYWlkQVBJIH0gZnJvbSAnLi9tZXJtYWlkLW9wdGlvbnMnO1xyXG5cclxuLy8gY2xpcGJvYXJkXHJcbmRlY2xhcmUgbGV0IENsaXBib2FyZEpTOiB7XHJcbiAgbmV3IChcclxuICAgIHNlbGVjdG9yOiBzdHJpbmcgfCBFbGVtZW50IHwgTm9kZUxpc3RPZjxFbGVtZW50PixcclxuICAgIG9wdGlvbnM/OiB7IHRleHQ/OiAoZWxlbTogRWxlbWVudCkgPT4gc3RyaW5nOyB9LFxyXG4gICk6IHR5cGVvZiBDbGlwYm9hcmRKUztcclxuICBkZXN0cm95KCk6IHZvaWQ7XHJcbn07XHJcblxyXG4vLyBlbW9qaVxyXG5kZWNsYXJlIGxldCBqb3lwaXhlbHM6IHtcclxuICBzaG9ydG5hbWVUb1VuaWNvZGUoaW5wdXQ6IHN0cmluZyk6IHN0cmluZztcclxufTtcclxuXHJcbi8vIGthdGV4XHJcbmRlY2xhcmUgbGV0IGthdGV4OiB1bmtub3duO1xyXG5kZWNsYXJlIGZ1bmN0aW9uIHJlbmRlck1hdGhJbkVsZW1lbnQoZWxlbTogSFRNTEVsZW1lbnQsIG9wdGlvbnM/OiBLYXRleE9wdGlvbnMpOiB2b2lkO1xyXG5cclxuLy8gbWVybWFpZFxyXG5kZWNsYXJlIGxldCBtZXJtYWlkOiB7XHJcbiAgaW5pdGlhbGl6ZTogKG9wdGlvbnM6IE1lcm1haWRBUEkuQ29uZmlnKSA9PiB2b2lkO1xyXG4gIGluaXQ6IChub2Rlczogc3RyaW5nIHwgTm9kZSB8IE5vZGVMaXN0KSA9PiB2b2lkO1xyXG4gIHBhcnNlOiAodGV4dDogc3RyaW5nKSA9PiBzdHJpbmc7XHJcbn07XHJcblxyXG4vLyBwcmlzbVxyXG5kZWNsYXJlIGxldCBQcmlzbToge1xyXG4gIGhpZ2hsaWdodEFsbFVuZGVyOiAoZWxlbWVudDogRWxlbWVudCB8IERvY3VtZW50KSA9PiB2b2lkO1xyXG59O1xyXG5cclxuLyogZXNsaW50LWRpc2FibGUgbWF4LWxlbiAqL1xyXG5leHBvcnQgY29uc3QgZXJyb3JKb3lQaXhlbHNOb3RMb2FkZWQgPSAnW25neC1tYXJrZG93bl0gV2hlbiB1c2luZyB0aGUgYGVtb2ppYCBhdHRyaWJ1dGUgeW91ICpoYXZlIHRvKiBpbmNsdWRlIEVtb2ppLVRvb2xraXQgZmlsZXMgdG8gYGFuZ3VsYXIuanNvbmAgb3IgdXNlIGltcG9ydHMuIFNlZSBSRUFETUUgZm9yIG1vcmUgaW5mb3JtYXRpb24nO1xyXG5leHBvcnQgY29uc3QgZXJyb3JLYXRleE5vdExvYWRlZCA9ICdbbmd4LW1hcmtkb3duXSBXaGVuIHVzaW5nIHRoZSBga2F0ZXhgIGF0dHJpYnV0ZSB5b3UgKmhhdmUgdG8qIGluY2x1ZGUgS2FUZVggZmlsZXMgdG8gYGFuZ3VsYXIuanNvbmAgb3IgdXNlIGltcG9ydHMuIFNlZSBSRUFETUUgZm9yIG1vcmUgaW5mb3JtYXRpb24nO1xyXG5leHBvcnQgY29uc3QgZXJyb3JNZXJtYWlkTm90TG9hZGVkID0gJ1tuZ3gtbWFya2Rvd25dIFdoZW4gdXNpbmcgdGhlIGBtZXJtYWlkYCBhdHRyaWJ1dGUgeW91ICpoYXZlIHRvKiBpbmNsdWRlIE1lcm1haWQgZmlsZXMgdG8gYGFuZ3VsYXIuanNvbmAgb3IgdXNlIGltcG9ydHMuIFNlZSBSRUFETUUgZm9yIG1vcmUgaW5mb3JtYXRpb24nO1xyXG5leHBvcnQgY29uc3QgZXJyb3JDbGlwYm9hcmROb3RMb2FkZWQgPSAnW25neC1tYXJrZG93bl0gV2hlbiB1c2luZyB0aGUgYGNsaXBib2FyZGAgYXR0cmlidXRlIHlvdSAqaGF2ZSB0byogaW5jbHVkZSBDbGlwYm9hcmQgZmlsZXMgdG8gYGFuZ3VsYXIuanNvbmAgb3IgdXNlIGltcG9ydHMuIFNlZSBSRUFETUUgZm9yIG1vcmUgaW5mb3JtYXRpb24nO1xyXG5leHBvcnQgY29uc3QgZXJyb3JDbGlwYm9hcmRWaWV3Q29udGFpbmVyUmVxdWlyZWQgPSAnW25neC1tYXJrZG93bl0gV2hlbiB1c2luZyB0aGUgYGNsaXBib2FyZGAgYXR0cmlidXRlIHlvdSAqaGF2ZSB0byogcHJvdmlkZSB0aGUgYHZpZXdDb250YWluZXJSZWZgIHBhcmFtZXRlciB0byBgTWFya2Rvd25TZXJ2aWNlLnJlbmRlcigpYCBmdW5jdGlvbic7XHJcbmV4cG9ydCBjb25zdCBlcnJvclNyY1dpdGhvdXRIdHRwQ2xpZW50ID0gJ1tuZ3gtbWFya2Rvd25dIFdoZW4gdXNpbmcgdGhlIGBzcmNgIGF0dHJpYnV0ZSB5b3UgKmhhdmUgdG8qIHBhc3MgdGhlIGBIdHRwQ2xpZW50YCBhcyBhIHBhcmFtZXRlciBvZiB0aGUgYGZvclJvb3RgIG1ldGhvZC4gU2VlIFJFQURNRSBmb3IgbW9yZSBpbmZvcm1hdGlvbic7XHJcbi8qIGVzbGludC1lbmFibGUgbWF4LWxlbiAqL1xyXG5cclxuZXhwb3J0IGNvbnN0IFNFQ1VSSVRZX0NPTlRFWFQgPSBuZXcgSW5qZWN0aW9uVG9rZW48U2VjdXJpdHlDb250ZXh0PignU0VDVVJJVFlfQ09OVEVYVCcpO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBQYXJzZU9wdGlvbnMge1xyXG4gIGRlY29kZUh0bWw/OiBib29sZWFuO1xyXG4gIGlubGluZT86IGJvb2xlYW47XHJcbiAgZW1vamk/OiBib29sZWFuO1xyXG4gIG1lcm1haWQ/OiBib29sZWFuO1xyXG4gIG1hcmtlZE9wdGlvbnM/OiBNYXJrZWRPcHRpb25zO1xyXG4gIGRpc2FibGVTYW5pdGl6ZXI/OiBib29sZWFuO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFJlbmRlck9wdGlvbnMge1xyXG4gIGNsaXBib2FyZD86IGJvb2xlYW47XHJcbiAgY2xpcGJvYXJkT3B0aW9ucz86IENsaXBib2FyZFJlbmRlck9wdGlvbnM7XHJcbiAga2F0ZXg/OiBib29sZWFuO1xyXG4gIGthdGV4T3B0aW9ucz86IEthdGV4T3B0aW9ucztcclxuICBtZXJtYWlkPzogYm9vbGVhbjtcclxuICBtZXJtYWlkT3B0aW9ucz86IE1lcm1haWRBUEkuQ29uZmlnO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgRXh0ZW5kZWRSZW5kZXJlciBleHRlbmRzIFJlbmRlcmVyIHtcclxuICDJtU5neE1hcmtkb3duUmVuZGVyZXJFeHRlbmRlZCA9IGZhbHNlO1xyXG59XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBNYXJrZG93blNlcnZpY2Uge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IERFRkFVTFRfTUFSS0VEX09QVElPTlM6IE1hcmtlZE9wdGlvbnMgPSB7XHJcbiAgICByZW5kZXJlcjogbmV3IE1hcmtlZFJlbmRlcmVyKCksXHJcbiAgfTtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBERUZBVUxUX0tBVEVYX09QVElPTlM6IEthdGV4T3B0aW9ucyA9IHtcclxuICAgIGRlbGltaXRlcnM6IFtcclxuICAgICAgeyBsZWZ0OiBcIiQkXCIsIHJpZ2h0OiBcIiQkXCIsIGRpc3BsYXk6IHRydWUgfSxcclxuICAgICAgeyBsZWZ0OiBcIiRcIiwgcmlnaHQ6IFwiJFwiLCBkaXNwbGF5OiBmYWxzZSB9LFxyXG4gICAgICB7IGxlZnQ6IFwiXFxcXChcIiwgcmlnaHQ6IFwiXFxcXClcIiwgZGlzcGxheTogZmFsc2UgfSxcclxuICAgICAgeyBsZWZ0OiBcIlxcXFxiZWdpbntlcXVhdGlvbn1cIiwgcmlnaHQ6IFwiXFxcXGVuZHtlcXVhdGlvbn1cIiwgZGlzcGxheTogdHJ1ZSB9LFxyXG4gICAgICB7IGxlZnQ6IFwiXFxcXGJlZ2lue2FsaWdufVwiLCByaWdodDogXCJcXFxcZW5ke2FsaWdufVwiLCBkaXNwbGF5OiB0cnVlIH0sXHJcbiAgICAgIHsgbGVmdDogXCJcXFxcYmVnaW57YWxpZ25hdH1cIiwgcmlnaHQ6IFwiXFxcXGVuZHthbGlnbmF0fVwiLCBkaXNwbGF5OiB0cnVlIH0sXHJcbiAgICAgIHsgbGVmdDogXCJcXFxcYmVnaW57Z2F0aGVyfVwiLCByaWdodDogXCJcXFxcZW5ke2dhdGhlcn1cIiwgZGlzcGxheTogdHJ1ZSB9LFxyXG4gICAgICB7IGxlZnQ6IFwiXFxcXGJlZ2lue0NEfVwiLCByaWdodDogXCJcXFxcZW5ke0NEfVwiLCBkaXNwbGF5OiB0cnVlIH0sXHJcbiAgICAgIHsgbGVmdDogXCJcXFxcW1wiLCByaWdodDogXCJcXFxcXVwiLCBkaXNwbGF5OiB0cnVlIH0sXHJcbiAgICBdLFxyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgREVGQVVMVF9NRVJNQUlEX09QVElPTlM6IE1lcm1haWRBUEkuQ29uZmlnID0ge1xyXG4gICAgc3RhcnRPbkxvYWQ6IGZhbHNlLFxyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgREVGQVVMVF9DTElQQk9BUkRfT1BUSU9OUzogQ2xpcGJvYXJkT3B0aW9ucyA9IHtcclxuICAgIGJ1dHRvbkNvbXBvbmVudDogdW5kZWZpbmVkLFxyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgREVGQVVMVF9QQVJTRV9PUFRJT05TOiBQYXJzZU9wdGlvbnMgPSB7XHJcbiAgICBkZWNvZGVIdG1sOiBmYWxzZSxcclxuICAgIGlubGluZTogZmFsc2UsXHJcbiAgICBlbW9qaTogZmFsc2UsXHJcbiAgICBtZXJtYWlkOiBmYWxzZSxcclxuICAgIG1hcmtlZE9wdGlvbnM6IHRoaXMuREVGQVVMVF9NQVJLRURfT1BUSU9OUyxcclxuICAgIGRpc2FibGVTYW5pdGl6ZXI6IGZhbHNlLFxyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgREVGQVVMVF9SRU5ERVJfT1BUSU9OUzogUmVuZGVyT3B0aW9ucyA9IHtcclxuICAgIGNsaXBib2FyZDogZmFsc2UsXHJcbiAgICBjbGlwYm9hcmRPcHRpb25zOiB1bmRlZmluZWQsXHJcbiAgICBrYXRleDogZmFsc2UsXHJcbiAgICBrYXRleE9wdGlvbnM6IHVuZGVmaW5lZCxcclxuICAgIG1lcm1haWQ6IGZhbHNlLFxyXG4gICAgbWVybWFpZE9wdGlvbnM6IHVuZGVmaW5lZCxcclxuICB9O1xyXG5cclxuICBwcml2YXRlIF9vcHRpb25zOiBNYXJrZWRPcHRpb25zIHwgdW5kZWZpbmVkO1xyXG5cclxuICBnZXQgb3B0aW9ucygpOiBNYXJrZWRPcHRpb25zIHsgcmV0dXJuIHRoaXMuX29wdGlvbnMhOyB9XHJcbiAgc2V0IG9wdGlvbnModmFsdWU6IE1hcmtlZE9wdGlvbnMgfCB1bmRlZmluZWQpIHtcclxuICAgIHRoaXMuX29wdGlvbnMgPSB7IC4uLnRoaXMuREVGQVVMVF9NQVJLRURfT1BUSU9OUywgLi4udmFsdWUgfTtcclxuICB9XHJcblxyXG4gIGdldCByZW5kZXJlcigpOiBNYXJrZWRSZW5kZXJlciB7IHJldHVybiB0aGlzLm9wdGlvbnMucmVuZGVyZXIhOyB9XHJcbiAgc2V0IHJlbmRlcmVyKHZhbHVlOiBNYXJrZWRSZW5kZXJlcikge1xyXG4gICAgdGhpcy5vcHRpb25zLnJlbmRlcmVyID0gdmFsdWU7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IF9yZWxvYWQkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcclxuICByZWFkb25seSByZWxvYWQkID0gdGhpcy5fcmVsb2FkJC5hc09ic2VydmFibGUoKTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtOiBPYmplY3QsXHJcbiAgICBASW5qZWN0KFNFQ1VSSVRZX0NPTlRFWFQpIHByaXZhdGUgc2VjdXJpdHlDb250ZXh0OiBTZWN1cml0eUNvbnRleHQsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGNsaXBib2FyZE9wdGlvbnM6IENsaXBib2FyZE9wdGlvbnMsXHJcbiAgICBAT3B0aW9uYWwoKSBvcHRpb25zOiBNYXJrZWRPcHRpb25zLFxyXG4gICAgcHJpdmF0ZSBzYW5pdGl6ZXI6IERvbVNhbml0aXplcixcclxuICApIHtcclxuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XHJcbiAgfVxyXG5cclxuICBwYXJzZShtYXJrZG93bjogc3RyaW5nLCBwYXJzZU9wdGlvbnM6IFBhcnNlT3B0aW9ucyA9IHRoaXMuREVGQVVMVF9QQVJTRV9PUFRJT05TKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IHtcclxuICAgICAgZGVjb2RlSHRtbCxcclxuICAgICAgaW5saW5lLFxyXG4gICAgICBlbW9qaSxcclxuICAgICAgbWVybWFpZCxcclxuICAgICAgZGlzYWJsZVNhbml0aXplcixcclxuICAgIH0gPSBwYXJzZU9wdGlvbnM7XHJcblxyXG4gICAgY29uc3QgbWFya2VkT3B0aW9ucyA9IHtcclxuICAgICAgLi4udGhpcy5vcHRpb25zLFxyXG4gICAgICAuLi5wYXJzZU9wdGlvbnMubWFya2VkT3B0aW9ucyxcclxuICAgIH07XHJcblxyXG4gICAgaWYgKG1lcm1haWQpIHtcclxuICAgICAgdGhpcy5yZW5kZXJlciA9IHRoaXMuZXh0ZW5kUmVuZGVyZXIobWFya2VkT3B0aW9ucy5yZW5kZXJlciB8fCBuZXcgUmVuZGVyZXIoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdHJpbW1lZCA9IHRoaXMudHJpbUluZGVudGF0aW9uKG1hcmtkb3duKTtcclxuICAgIGNvbnN0IGRlY29kZWQgPSBkZWNvZGVIdG1sID8gdGhpcy5kZWNvZGVIdG1sKHRyaW1tZWQpIDogdHJpbW1lZDtcclxuICAgIGNvbnN0IGVtb2ppZmllZCA9IGVtb2ppID8gdGhpcy5wYXJzZUVtb2ppKGRlY29kZWQpIDogZGVjb2RlZDtcclxuICAgIGNvbnN0IG1hcmtlZCA9IHRoaXMucGFyc2VNYXJrZWQoZW1vamlmaWVkLCBtYXJrZWRPcHRpb25zLCBpbmxpbmUpO1xyXG4gICAgY29uc3Qgc2FuaXRpemVkID0gZGlzYWJsZVNhbml0aXplciA/IG1hcmtlZCA6IHRoaXMuc2FuaXRpemVyLnNhbml0aXplKHRoaXMuc2VjdXJpdHlDb250ZXh0LCBtYXJrZWQpO1xyXG5cclxuICAgIHJldHVybiBzYW5pdGl6ZWQgfHwgJyc7XHJcbiAgfVxyXG5cclxuICByZW5kZXIoZWxlbWVudDogSFRNTEVsZW1lbnQsIG9wdGlvbnM6IFJlbmRlck9wdGlvbnMgPSB0aGlzLkRFRkFVTFRfUkVOREVSX09QVElPTlMsIHZpZXdDb250YWluZXJSZWY/OiBWaWV3Q29udGFpbmVyUmVmKTogdm9pZCB7XHJcbiAgICBjb25zdCB7XHJcbiAgICAgIGNsaXBib2FyZCxcclxuICAgICAgY2xpcGJvYXJkT3B0aW9ucyxcclxuICAgICAga2F0ZXgsXHJcbiAgICAgIGthdGV4T3B0aW9ucyxcclxuICAgICAgbWVybWFpZCxcclxuICAgICAgbWVybWFpZE9wdGlvbnMsXHJcbiAgICB9ID0gb3B0aW9ucztcclxuXHJcbiAgICBpZiAoY2xpcGJvYXJkKSB7XHJcbiAgICAgIHRoaXMucmVuZGVyQ2xpcGJvYXJkKGVsZW1lbnQsIHZpZXdDb250YWluZXJSZWYsIHtcclxuICAgICAgICAuLi50aGlzLkRFRkFVTFRfQ0xJUEJPQVJEX09QVElPTlMsXHJcbiAgICAgICAgLi4udGhpcy5jbGlwYm9hcmRPcHRpb25zLFxyXG4gICAgICAgIC4uLmNsaXBib2FyZE9wdGlvbnMsXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKGthdGV4KSB7XHJcbiAgICAgIHRoaXMucmVuZGVyS2F0ZXgoZWxlbWVudCwge1xyXG4gICAgICAgIC4uLnRoaXMuREVGQVVMVF9LQVRFWF9PUFRJT05TLFxyXG4gICAgICAgIC4uLmthdGV4T3B0aW9ucyxcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAobWVybWFpZCkge1xyXG4gICAgICB0aGlzLnJlbmRlck1lcm1haWQoZWxlbWVudCwge1xyXG4gICAgICAgIC4uLnRoaXMuREVGQVVMVF9NRVJNQUlEX09QVElPTlMsXHJcbiAgICAgICAgLi4ubWVybWFpZE9wdGlvbnMsXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuaGlnaGxpZ2h0KGVsZW1lbnQpO1xyXG4gIH1cclxuXHJcbiAgcmVsb2FkKCk6IHZvaWQge1xyXG4gICAgdGhpcy5fcmVsb2FkJC5uZXh0KCk7XHJcbiAgfVxyXG5cclxuICBnZXRTb3VyY2Uoc3JjOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xyXG4gICAgaWYgKCF0aGlzLmh0dHApIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yU3JjV2l0aG91dEh0dHBDbGllbnQpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuaHR0cFxyXG4gICAgICAuZ2V0KHNyYywgeyByZXNwb25zZVR5cGU6ICd0ZXh0JyB9KVxyXG4gICAgICAucGlwZShtYXAobWFya2Rvd24gPT4gdGhpcy5oYW5kbGVFeHRlbnNpb24oc3JjLCBtYXJrZG93bikpKTtcclxuICB9XHJcblxyXG4gIGhpZ2hsaWdodChlbGVtZW50PzogRWxlbWVudCB8IERvY3VtZW50KTogdm9pZCB7XHJcbiAgICBpZiAoIWlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm0pKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgUHJpc20gPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBQcmlzbS5oaWdobGlnaHRBbGxVbmRlciA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKCFlbGVtZW50KSB7XHJcbiAgICAgIGVsZW1lbnQgPSBkb2N1bWVudDtcclxuICAgIH1cclxuICAgIGNvbnN0IG5vTGFuZ3VhZ2VFbGVtZW50cyA9IGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgncHJlIGNvZGU6bm90KFtjbGFzcyo9XCJsYW5ndWFnZS1cIl0pJyk7XHJcbiAgICBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsKG5vTGFuZ3VhZ2VFbGVtZW50cywgKHg6IEVsZW1lbnQpID0+IHguY2xhc3NMaXN0LmFkZCgnbGFuZ3VhZ2Utbm9uZScpKTtcclxuICAgIFByaXNtLmhpZ2hsaWdodEFsbFVuZGVyKGVsZW1lbnQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBkZWNvZGVIdG1sKGh0bWw6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBpZiAoIWlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm0pKSB7XHJcbiAgICAgIHJldHVybiBodG1sO1xyXG4gICAgfVxyXG4gICAgY29uc3QgdGV4dGFyZWEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZXh0YXJlYScpO1xyXG4gICAgdGV4dGFyZWEuaW5uZXJIVE1MID0gaHRtbDtcclxuICAgIHJldHVybiB0ZXh0YXJlYS52YWx1ZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZXh0ZW5kUmVuZGVyZXIocmVuZGVyZXI6IFJlbmRlcmVyKTogUmVuZGVyZXIge1xyXG4gICAgY29uc3QgZXh0ZW5kZWRSZW5kZXJlciA9IHJlbmRlcmVyIGFzIEV4dGVuZGVkUmVuZGVyZXI7XHJcbiAgICBpZiAoZXh0ZW5kZWRSZW5kZXJlci7JtU5neE1hcmtkb3duUmVuZGVyZXJFeHRlbmRlZCA9PT0gdHJ1ZSkge1xyXG4gICAgICByZXR1cm4gcmVuZGVyZXI7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC91bmJvdW5kLW1ldGhvZFxyXG4gICAgY29uc3QgZGVmYXVsdENvZGUgPSByZW5kZXJlci5jb2RlO1xyXG4gICAgcmVuZGVyZXIuY29kZSA9IGZ1bmN0aW9uIChjb2RlOiBzdHJpbmcsIGxhbmd1YWdlOiBzdHJpbmcgfCB1bmRlZmluZWQsIGlzRXNjYXBlZDogYm9vbGVhbikge1xyXG4gICAgICByZXR1cm4gbGFuZ3VhZ2UgPT09ICdtZXJtYWlkJ1xyXG4gICAgICAgID8gYDxkaXYgY2xhc3M9XCJtZXJtYWlkXCI+JHtjb2RlfTwvZGl2PmBcclxuICAgICAgICA6IGRlZmF1bHRDb2RlLmNhbGwodGhpcywgY29kZSwgbGFuZ3VhZ2UsIGlzRXNjYXBlZCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4dGVuZGVkUmVuZGVyZXIuybVOZ3hNYXJrZG93blJlbmRlcmVyRXh0ZW5kZWQgPSB0cnVlO1xyXG5cclxuICAgIHJldHVybiByZW5kZXJlcjtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlRXh0ZW5zaW9uKHNyYzogc3RyaW5nLCBtYXJrZG93bjogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IHVybFByb3RvY29sSW5kZXggPSBzcmMubGFzdEluZGV4T2YoJzovLycpO1xyXG4gICAgY29uc3QgdXJsV2l0aG91dFByb3RvY29sID0gdXJsUHJvdG9jb2xJbmRleCA+IC0xXHJcbiAgICAgID8gc3JjLnN1YnN0cmluZyh1cmxQcm90b2NvbEluZGV4ICsgNClcclxuICAgICAgOiBzcmM7XHJcblxyXG4gICAgY29uc3QgbGFzdFNsYXNoSW5kZXggPSB1cmxXaXRob3V0UHJvdG9jb2wubGFzdEluZGV4T2YoJy8nKTtcclxuICAgIGNvbnN0IGxhc3RVcmxTZWdtZW50ID0gbGFzdFNsYXNoSW5kZXggPiAtMVxyXG4gICAgICA/IHVybFdpdGhvdXRQcm90b2NvbC5zdWJzdHJpbmcobGFzdFNsYXNoSW5kZXggKyAxKS5zcGxpdCgnPycpWzBdXHJcbiAgICAgIDogJyc7XHJcblxyXG4gICAgY29uc3QgbGFzdERvdEluZGV4ID0gbGFzdFVybFNlZ21lbnQubGFzdEluZGV4T2YoJy4nKTtcclxuICAgIGNvbnN0IGV4dGVuc2lvbiA9IGxhc3REb3RJbmRleCA+IC0xXHJcbiAgICAgID8gbGFzdFVybFNlZ21lbnQuc3Vic3RyaW5nKGxhc3REb3RJbmRleCArIDEpXHJcbiAgICAgIDogJyc7XHJcblxyXG4gICAgcmV0dXJuICEhZXh0ZW5zaW9uICYmIGV4dGVuc2lvbiAhPT0gJ21kJ1xyXG4gICAgICA/ICdgYGAnICsgZXh0ZW5zaW9uICsgJ1xcbicgKyBtYXJrZG93biArICdcXG5gYGAnXHJcbiAgICAgIDogbWFya2Rvd247XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlTWFya2VkKGh0bWw6IHN0cmluZywgbWFya2VkT3B0aW9uczogTWFya2VkT3B0aW9ucywgaW5saW5lID0gZmFsc2UpOiBzdHJpbmcge1xyXG4gICAgaWYgKCFpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtKSkge1xyXG4gICAgICByZXR1cm4gaHRtbDtcclxuICAgIH1cclxuICAgIGlmIChpbmxpbmUpIHtcclxuICAgICAgcmV0dXJuIG1hcmtlZC5wYXJzZUlubGluZShodG1sLCBtYXJrZWRPcHRpb25zKTtcclxuICAgIH1cclxuICAgIHJldHVybiBtYXJrZWQucGFyc2UoaHRtbCwgbWFya2VkT3B0aW9ucyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlRW1vamkoaHRtbDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGlmICghaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybSkpIHtcclxuICAgICAgcmV0dXJuIGh0bWw7XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIGpveXBpeGVscyA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGpveXBpeGVscy5zaG9ydG5hbWVUb1VuaWNvZGUgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvckpveVBpeGVsc05vdExvYWRlZCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gam95cGl4ZWxzLnNob3J0bmFtZVRvVW5pY29kZShodG1sKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVuZGVyS2F0ZXgoZWxlbWVudDogSFRNTEVsZW1lbnQsIG9wdGlvbnM6IEthdGV4T3B0aW9ucyk6IHZvaWQge1xyXG4gICAgaWYgKCFpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIGthdGV4ID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgcmVuZGVyTWF0aEluRWxlbWVudCA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yS2F0ZXhOb3RMb2FkZWQpO1xyXG4gICAgfVxyXG4gICAgcmVuZGVyTWF0aEluRWxlbWVudChlbGVtZW50LCBvcHRpb25zKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVuZGVyQ2xpcGJvYXJkKGVsZW1lbnQ6IEhUTUxFbGVtZW50LCB2aWV3Q29udGFpbmVyUmVmOiBWaWV3Q29udGFpbmVyUmVmIHwgdW5kZWZpbmVkLCBvcHRpb25zOiBDbGlwYm9hcmRSZW5kZXJPcHRpb25zKTogdm9pZCB7XHJcbiAgICBpZiAoIWlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm0pKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgQ2xpcGJvYXJkSlMgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvckNsaXBib2FyZE5vdExvYWRlZCk7XHJcbiAgICB9XHJcbiAgICBpZiAoIXZpZXdDb250YWluZXJSZWYpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yQ2xpcGJvYXJkVmlld0NvbnRhaW5lclJlcXVpcmVkKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB7XHJcbiAgICAgIGJ1dHRvbkNvbXBvbmVudCxcclxuICAgICAgYnV0dG9uVGVtcGxhdGUsXHJcbiAgICB9ID0gb3B0aW9ucztcclxuXHJcbiAgICAvLyB0YXJnZXQgZXZlcnkgPHByZT4gZWxlbWVudHNcclxuICAgIGNvbnN0IHByZUVsZW1lbnRzID0gZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdwcmUnKTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJlRWxlbWVudHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgY29uc3QgcHJlRWxlbWVudCA9IHByZUVsZW1lbnRzLml0ZW0oaSk7XHJcblxyXG4gICAgICAvLyBjcmVhdGUgPHByZT4gd3JhcHBlciBlbGVtZW50XHJcbiAgICAgIGNvbnN0IHByZVdyYXBwZXJFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgIHByZVdyYXBwZXJFbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gJ3JlbGF0aXZlJztcclxuICAgICAgcHJlRWxlbWVudC5wYXJlbnROb2RlIS5pbnNlcnRCZWZvcmUocHJlV3JhcHBlckVsZW1lbnQsIHByZUVsZW1lbnQpO1xyXG4gICAgICBwcmVXcmFwcGVyRWxlbWVudC5hcHBlbmRDaGlsZChwcmVFbGVtZW50KTtcclxuXHJcbiAgICAgIC8vIGNyZWF0ZSB0b29sYmFyIGVsZW1lbnRcclxuICAgICAgY29uc3QgdG9vbGJhcldyYXBwZXJFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgIHRvb2xiYXJXcmFwcGVyRWxlbWVudC5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7XHJcbiAgICAgIHRvb2xiYXJXcmFwcGVyRWxlbWVudC5zdHlsZS50b3AgPSAnLjVlbSc7XHJcbiAgICAgIHRvb2xiYXJXcmFwcGVyRWxlbWVudC5zdHlsZS5yaWdodCA9ICcuNWVtJztcclxuICAgICAgdG9vbGJhcldyYXBwZXJFbGVtZW50LnN0eWxlLm9wYWNpdHkgPSAnMCc7XHJcbiAgICAgIHRvb2xiYXJXcmFwcGVyRWxlbWVudC5zdHlsZS50cmFuc2l0aW9uID0gJ29wYWNpdHkgMjUwbXMgZWFzZS1vdXQnO1xyXG4gICAgICBwcmVXcmFwcGVyRWxlbWVudC5pbnNlcnRBZGphY2VudEVsZW1lbnQoJ2JlZm9yZWVuZCcsIHRvb2xiYXJXcmFwcGVyRWxlbWVudCk7XHJcblxyXG4gICAgICAvLyByZWdpc3RlciBsaXN0ZW5lciB0byBzaG93L2hpZGUgdG9vbGJhclxyXG4gICAgICBwcmVFbGVtZW50Lm9ubW91c2VvdmVyID0gKCkgPT4gdG9vbGJhcldyYXBwZXJFbGVtZW50LnN0eWxlLm9wYWNpdHkgPSAnMSc7XHJcbiAgICAgIHByZUVsZW1lbnQub25tb3VzZW91dCA9ICgpID0+IHRvb2xiYXJXcmFwcGVyRWxlbWVudC5zdHlsZS5vcGFjaXR5ID0gJzAnO1xyXG5cclxuICAgICAgLy8gZGVjbGFyZSBlbWJlZGRlZFZpZXdSZWYgaG9sZGluZyB2YXJpYWJsZVxyXG4gICAgICBsZXQgZW1iZWRkZWRWaWV3UmVmOiBFbWJlZGRlZFZpZXdSZWY8dW5rbm93bj47XHJcblxyXG4gICAgICAvLyB1c2UgcHJvdmlkZWQgY29tcG9uZW50IHZpYSBpbnB1dCBwcm9wZXJ0eVxyXG4gICAgICAvLyBvciBwcm92aWRlZCB2aWEgQ2xpcGJvYXJkT3B0aW9ucyBwcm92aWRlclxyXG4gICAgICBpZiAoYnV0dG9uQ29tcG9uZW50KSB7XHJcbiAgICAgICAgY29uc3QgY29tcG9uZW50UmVmID0gdmlld0NvbnRhaW5lclJlZi5jcmVhdGVDb21wb25lbnQoYnV0dG9uQ29tcG9uZW50KTtcclxuICAgICAgICBlbWJlZGRlZFZpZXdSZWYgPSBjb21wb25lbnRSZWYuaG9zdFZpZXcgYXMgRW1iZWRkZWRWaWV3UmVmPHVua25vd24+O1xyXG4gICAgICB9XHJcbiAgICAgIC8vIHVzZSBwcm92aWRlZCB0ZW1wbGF0ZSB2aWEgaW5wdXQgcHJvcGVydHlcclxuICAgICAgZWxzZSBpZiAoYnV0dG9uVGVtcGxhdGUpIHtcclxuICAgICAgICBlbWJlZGRlZFZpZXdSZWYgPSB2aWV3Q29udGFpbmVyUmVmLmNyZWF0ZUVtYmVkZGVkVmlldyhidXR0b25UZW1wbGF0ZSk7XHJcbiAgICAgIH1cclxuICAgICAgLy8gdXNlIGRlZmF1bHQgY29tcG9uZW50XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudFJlZiA9IHZpZXdDb250YWluZXJSZWYuY3JlYXRlQ29tcG9uZW50KENsaXBib2FyZEJ1dHRvbkNvbXBvbmVudCk7XHJcbiAgICAgICAgZW1iZWRkZWRWaWV3UmVmID0gY29tcG9uZW50UmVmLmhvc3RWaWV3IGFzIEVtYmVkZGVkVmlld1JlZjx1bmtub3duPjtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gZGVjbGFyZSBjbGlwYm9hcmQgaW5zdGFuY2UgdmFyaWFibGVcclxuICAgICAgbGV0IGNsaXBib2FyZEluc3RhbmNlOiB0eXBlb2YgQ2xpcGJvYXJkSlM7XHJcblxyXG4gICAgICAvLyBhdHRhY2ggY2xpcGJvYXJkLmpzIHRvIHJvb3Qgbm9kZVxyXG4gICAgICBlbWJlZGRlZFZpZXdSZWYucm9vdE5vZGVzLmZvckVhY2goKG5vZGU6IEhUTUxFbGVtZW50KSA9PiB7XHJcbiAgICAgICAgbm9kZS5vbm1vdXNlb3ZlciA9ICgpID0+IHRvb2xiYXJXcmFwcGVyRWxlbWVudC5zdHlsZS5vcGFjaXR5ID0gJzEnO1xyXG4gICAgICAgIHRvb2xiYXJXcmFwcGVyRWxlbWVudC5hcHBlbmRDaGlsZChub2RlKTtcclxuICAgICAgICBjbGlwYm9hcmRJbnN0YW5jZSA9IG5ldyBDbGlwYm9hcmRKUyhub2RlLCB7IHRleHQ6ICgpID0+IHByZUVsZW1lbnQuaW5uZXJUZXh0IH0pO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIC8vIGRlc3Ryb3kgY2xpcGJvYXJkIGluc3RhbmNlIHdoZW4gdmlldyBpcyBkZXN0cm95ZWRcclxuICAgICAgZW1iZWRkZWRWaWV3UmVmLm9uRGVzdHJveSgoKSA9PiBjbGlwYm9hcmRJbnN0YW5jZS5kZXN0cm95KCkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZW5kZXJNZXJtYWlkKGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBvcHRpb25zOiBNZXJtYWlkQVBJLkNvbmZpZyA9IHRoaXMuREVGQVVMVF9NRVJNQUlEX09QVElPTlMpOiB2b2lkIHtcclxuICAgIGlmICghaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybSkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBtZXJtYWlkID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgbWVybWFpZC5pbml0ID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNZXJtYWlkTm90TG9hZGVkKTtcclxuICAgIH1cclxuICAgIGNvbnN0IG1lcm1haWRFbGVtZW50cyA9IGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm1lcm1haWQnKTtcclxuICAgIGlmIChtZXJtYWlkRWxlbWVudHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIG1lcm1haWQuaW5pdGlhbGl6ZShvcHRpb25zKTtcclxuICAgIG1lcm1haWQuaW5pdChtZXJtYWlkRWxlbWVudHMpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB0cmltSW5kZW50YXRpb24obWFya2Rvd246IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBpZiAoIW1hcmtkb3duKSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIGxldCBpbmRlbnRTdGFydDogbnVtYmVyO1xyXG4gICAgcmV0dXJuIG1hcmtkb3duXHJcbiAgICAgIC5zcGxpdCgnXFxuJylcclxuICAgICAgLm1hcChsaW5lID0+IHtcclxuICAgICAgICBsZXQgbGluZUlkZW50U3RhcnQgPSBpbmRlbnRTdGFydDtcclxuICAgICAgICBpZiAobGluZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICBsaW5lSWRlbnRTdGFydCA9IGlzTmFOKGxpbmVJZGVudFN0YXJ0KVxyXG4gICAgICAgICAgICA/IGxpbmUuc2VhcmNoKC9cXFN8JC8pXHJcbiAgICAgICAgICAgIDogTWF0aC5taW4obGluZS5zZWFyY2goL1xcU3wkLyksIGxpbmVJZGVudFN0YXJ0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGlzTmFOKGluZGVudFN0YXJ0KSkge1xyXG4gICAgICAgICAgaW5kZW50U3RhcnQgPSBsaW5lSWRlbnRTdGFydDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGxpbmVJZGVudFN0YXJ0XHJcbiAgICAgICAgICA/IGxpbmUuc3Vic3RyaW5nKGxpbmVJZGVudFN0YXJ0KVxyXG4gICAgICAgICAgOiBsaW5lO1xyXG4gICAgICB9KS5qb2luKCdcXG4nKTtcclxuICB9XHJcbn1cclxuIl19